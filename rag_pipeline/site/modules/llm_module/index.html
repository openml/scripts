
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../general_utils/">
      
      
        <link rel="next" href="../metadata_module/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.20">
    
    
      
        <title>Llm module - OpenML RAG Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#llm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OpenML RAG Documentation" class="md-header__button md-logo" aria-label="OpenML RAG Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenML RAG Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Llm module
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenML RAG Documentation" class="md-nav__button md-logo" aria-label="OpenML RAG Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    OpenML RAG Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to MkDocs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../general_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Llm module
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Llm module
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      llm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.add_documents_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      add_documents_to_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.create_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      create_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.generate_unique_documents" class="md-nav__link">
    <span class="md-ellipsis">
      generate_unique_documents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.get_collection_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_collection_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.initialize_llm_chain" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_llm_chain
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_and_process_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_and_process_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_document_and_create_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      load_document_and_create_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      load_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.setup_vector_db_and_qa" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vector_db_and_qa
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata_module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../result_gen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Result gen
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      llm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.add_documents_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      add_documents_to_db
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.create_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      create_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.generate_unique_documents" class="md-nav__link">
    <span class="md-ellipsis">
      generate_unique_documents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.get_collection_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_collection_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.initialize_llm_chain" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_llm_chain
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_and_process_data" class="md-nav__link">
    <span class="md-ellipsis">
      load_and_process_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_document_and_create_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      load_document_and_create_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_model" class="md-nav__link">
    <span class="md-ellipsis">
      load_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.load_vector_store" class="md-nav__link">
    <span class="md-ellipsis">
      load_vector_store
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm.setup_vector_db_and_qa" class="md-nav__link">
    <span class="md-ellipsis">
      setup_vector_db_and_qa
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Llm module</h1>

<div class="doc doc-object doc-module">



<a id="llm"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="llm.add_documents_to_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_documents_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">unique_docs</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">)</span></code>

<a href="#llm.add_documents_to_db" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Add documents to the vector store in batches of 200.</p>
<p>Input: db (Chroma), unique_docs (list), unique_ids (list)</p>
<p>Returns: None</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_documents_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">unique_docs</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Add documents to the vector store in batches of 200.</span>

<span class="sd">    Input: db (Chroma), unique_docs (list), unique_ids (list)</span>

<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bs</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">unique_ids</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">),</span> <span class="n">bs</span><span class="p">)):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bs</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="n">unique_ids</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">bs</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.create_vector_store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_vector_store</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">,</span> <span class="n">chroma_client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span></code>

<a href="#llm.create_vector_store" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Create the vector store using Chroma db. The documents are loaded and processed, unique documents are generated, and the documents are added to the vector store.</p>
<p>Input: metadata_df (pd.DataFrame), chroma_client (chromadb.PersistentClient), config (dict), embeddings (HuggingFaceEmbeddings), collection_name (str)</p>
<p>Returns: db (Chroma)</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_vector_store</span><span class="p">(</span>
    <span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">chroma_client</span><span class="p">:</span><span class="n">ClientAPI</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> 
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chroma</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Create the vector store using Chroma db. The documents are loaded and processed, unique documents are generated, and the documents are added to the vector store.</span>

<span class="sd">    Input: metadata_df (pd.DataFrame), chroma_client (chromadb.PersistentClient), config (dict), embeddings (HuggingFaceEmbeddings), collection_name (str)</span>

<span class="sd">    Returns: db (Chroma)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">Chroma</span><span class="p">(</span>
        <span class="n">client</span><span class="o">=</span><span class="n">chroma_client</span><span class="p">,</span>
        <span class="n">embedding_function</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span>
        <span class="n">persist_directory</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">],</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">documents</span> <span class="o">=</span> <span class="n">load_and_process_data</span><span class="p">(</span>
        <span class="n">metadata_df</span><span class="p">,</span> <span class="n">page_content_column</span><span class="o">=</span><span class="s2">&quot;Combined_information&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;testing_flag&quot;</span><span class="p">]:</span>
        <span class="c1"># subset the data for testing</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;test_subset_2000&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Subsetting the data to 2000 rows.&quot;</span><span class="p">)</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span>
    <span class="n">unique_docs</span><span class="p">,</span> <span class="n">unique_ids</span> <span class="o">=</span> <span class="n">generate_unique_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Number of unique documents: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs Total documents: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_docs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No new documents to add.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># db.add_documents(unique_docs, ids=unique_ids)</span>
        <span class="n">add_documents_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">unique_docs</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">db</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.generate_unique_documents" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_unique_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span></code>

<a href="#llm.generate_unique_documents" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



<details class="description" open>
  <summary>Generate unique documents by removing duplicates. This is done by generating unique IDs for the documents and keeping only one of the duplicate IDs.</summary>
  <p>Source: https://stackoverflow.com/questions/76265631/chromadb-add-single-document-only-if-it-doesnt-exist</p>
</details>      <p>Input: documents (list)</p>
<p>Returns: unique_docs (list), unique_ids (list)</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_unique_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Chroma</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Generate unique documents by removing duplicates. This is done by generating unique IDs for the documents and keeping only one of the duplicate IDs.</span>
<span class="sd">        Source: https://stackoverflow.com/questions/76265631/chromadb-add-single-document-only-if-it-doesnt-exist</span>

<span class="sd">    Input: documents (list)</span>

<span class="sd">    Returns: unique_docs (list), unique_ids (list)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remove duplicates based on ID (from database)</span>
    <span class="n">new_document_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Generating unique documents. Total documents: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_dids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;metadatas&quot;</span><span class="p">]])</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">old_dids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s2">&quot;metadatas&quot;</span><span class="p">]])</span>

    <span class="n">new_dids</span> <span class="o">=</span> <span class="n">new_document_ids</span> <span class="o">-</span> <span class="n">old_dids</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">documents</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">new_dids</span><span class="p">]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_DNS</span><span class="p">,</span><span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="p">))</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>

    <span class="c1"># Remove duplicates based on document content (from new documents)</span>
    <span class="n">unique_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
    <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">unique_docs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">doc</span>
            <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ids</span> <span class="ow">and</span> <span class="p">(</span><span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">unique_docs</span><span class="p">,</span> <span class="n">unique_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.get_collection_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_collection_name</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

<a href="#llm.get_collection_name" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Get the collection name based on the type of data provided in the config.</p>
<p>Input: config (dict)</p>
<p>Returns: str</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_collection_name</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Get the collection name based on the type of data provided in the config.</span>

<span class="sd">    Input: config (dict)</span>

<span class="sd">    Returns: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="s2">&quot;flows&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">],</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.initialize_llm_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_llm_chain</span><span class="p">(</span><span class="n">vectordb</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#llm.initialize_llm_chain" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Initialize the LLM chain and setup Retrieval QA with the specified configuration.</p>
<p>Input: vectordb (Chroma), config (dict)</p>
<p>Returns: qa (langchain.chains.retrieval_qa.base.RetrievalQA)</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">initialize_llm_chain</span><span class="p">(</span>
    <span class="n">vectordb</span><span class="p">:</span> <span class="n">Chroma</span><span class="p">,</span>
    <span class="n">config</span> <span class="p">:</span> <span class="nb">dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">langchain</span><span class="o">.</span><span class="n">chains</span><span class="o">.</span><span class="n">retrieval_qa</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">RetrievalQA</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Initialize the LLM chain and setup Retrieval QA with the specified configuration.</span>

<span class="sd">    Input: vectordb (Chroma), config (dict)</span>

<span class="sd">    Returns: qa (langchain.chains.retrieval_qa.base.RetrievalQA)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">vectordb</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(</span>
        <span class="n">search_type</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;search_type&quot;</span><span class="p">],</span>
        <span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_return_documents&quot;</span><span class="p">]},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.load_and_process_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_and_process_data</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">,</span> <span class="n">page_content_column</span><span class="p">)</span></code>

<a href="#llm.load_and_process_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Load and process the data for the vector store. Split the documents into chunks of 1000 characters.</p>
<p>Input: metadata_df (pd.DataFrame), page_content_column (str)</p>
<p>Returns: chunked documents (list)</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_and_process_data</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">page_content_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load and process the data for the vector store. Split the documents into chunks of 1000 characters.</span>

<span class="sd">    Input: metadata_df (pd.DataFrame), page_content_column (str)</span>

<span class="sd">    Returns: chunked documents (list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load data</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataFrameLoader</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">,</span> <span class="n">page_content_column</span><span class="o">=</span><span class="n">page_content_column</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="c1"># Split documents</span>
    <span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">documents</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.load_document_and_create_vector_store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_document_and_create_vector_store</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">,</span> <span class="n">chroma_client</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#llm.load_document_and_create_vector_store" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Loads the documents and creates the vector store. If the training flag is set to True,
the documents are added to the vector store. If the training flag is set to False,
the vector store is loaded from the persist directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>metadata_df</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The metadata dataframe.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>chroma_client</code></td>
            <td>
                  <code><span title="chromadb.PersistentClient">PersistentClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Chroma client.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>config</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration dictionary.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Chroma</code></td>            <td>
                  <code><span title="langchain_community.vectorstores.chroma.Chroma">Chroma</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Chroma vector store.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_document_and_create_vector_store</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">chroma_client</span><span class="p">:</span><span class="n">ClientAPI</span> <span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chroma</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the documents and creates the vector store. If the training flag is set to True,</span>
<span class="sd">    the documents are added to the vector store. If the training flag is set to False,</span>
<span class="sd">    the vector store is loaded from the persist directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata_df (pd.DataFrame): The metadata dataframe.</span>
<span class="sd">        chroma_client (chromadb.PersistentClient): The Chroma client.</span>
<span class="sd">        config (dict): The configuration dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Chroma: The Chroma vector store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">collection_name</span> <span class="o">=</span> <span class="n">get_collection_name</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">load_vector_store</span><span class="p">(</span><span class="n">chroma_client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">create_vector_store</span><span class="p">(</span>
        <span class="n">metadata_df</span><span class="p">,</span> <span class="n">chroma_client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">collection_name</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.load_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

<a href="#llm.load_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Load the model using HuggingFaceEmbeddings.</p>
<p>Input: config (dict)</p>
<p>Returns: HuggingFaceEmbeddings</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HuggingFaceEmbeddings</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load the model using HuggingFaceEmbeddings.</span>

<span class="sd">    Input: config (dict)</span>

<span class="sd">    Returns: HuggingFaceEmbeddings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Loading model...&quot;</span><span class="p">)</span>
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">],</span> <span class="s2">&quot;trust_remote_code&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">encode_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;normalize_embeddings&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">],</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">encode_kwargs</span><span class="o">=</span><span class="n">encode_kwargs</span><span class="p">,</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># trust_remote_code=True</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[INFO] Model loaded.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">embeddings</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.load_vector_store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_vector_store</span><span class="p">(</span><span class="n">chroma_client</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">)</span></code>

<a href="#llm.load_vector_store" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Load the vector store from the persist directory.</p>
<p>Input: chroma_client (chromadb.PersistentClient), config (dict), embeddings (HuggingFaceEmbeddings), collection_name (str)</p>
<p>Returns: Chroma</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_vector_store</span><span class="p">(</span><span class="n">chroma_client</span><span class="p">:</span> <span class="n">ClientAPI</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chroma</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load the vector store from the persist directory.</span>

<span class="sd">    Input: chroma_client (chromadb.PersistentClient), config (dict), embeddings (HuggingFaceEmbeddings), collection_name (str)</span>

<span class="sd">    Returns: Chroma</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Persist directory does not exist. Please run the training pipeline first.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">Chroma</span><span class="p">(</span>
        <span class="n">client</span><span class="o">=</span><span class="n">chroma_client</span><span class="p">,</span>
        <span class="n">persist_directory</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">],</span>
        <span class="n">embedding_function</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="llm.setup_vector_db_and_qa" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_vector_db_and_qa</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span></code>

<a href="#llm.setup_vector_db_and_qa" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Description: Create the vector database using Chroma db with each type of data in its own collection. Doing so allows us to have a single database with multiple collections, reducing the number of databases we need to manage.
This also downloads the embedding model if it does not exist. The QA chain is then initialized with the vector store and the configuration.</p>
<p>Input: config (dict), data_type (str), client (chromadb.PersistentClient)</p>
<p>Returns: qa (langchain.chains.retrieval_qa.base.RetrievalQA)</p>

            <details class="quote">
              <summary>Source code in <code>modules/llm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_vector_db_and_qa</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span><span class="n">ClientAPI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">langchain</span><span class="o">.</span><span class="n">chains</span><span class="o">.</span><span class="n">retrieval_qa</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">RetrievalQA</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Create the vector database using Chroma db with each type of data in its own collection. Doing so allows us to have a single database with multiple collections, reducing the number of databases we need to manage.</span>
<span class="sd">    This also downloads the embedding model if it does not exist. The QA chain is then initialized with the vector store and the configuration.</span>

<span class="sd">    Input: config (dict), data_type (str), client (chromadb.PersistentClient)</span>

<span class="sd">    Returns: qa (langchain.chains.retrieval_qa.base.RetrievalQA)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_type</span>
    <span class="c1"># Download the data if it does not exist</span>
    <span class="n">openml_data_object</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">get_all_metadata_from_openml</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span>
    <span class="p">)</span>
    <span class="c1"># Create the combined metadata dataframe</span>
    <span class="n">metadata_df</span><span class="p">,</span> <span class="n">all_metadata</span> <span class="o">=</span> <span class="n">create_metadata_dataframe</span><span class="p">(</span>
        <span class="n">openml_data_object</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">all_metadata</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
    <span class="p">)</span>
    <span class="c1"># Create the vector store</span>
    <span class="n">vectordb</span> <span class="o">=</span> <span class="n">load_document_and_create_vector_store</span><span class="p">(</span>
        <span class="n">metadata_df</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">chroma_client</span><span class="o">=</span><span class="n">client</span>
    <span class="p">)</span>
    <span class="c1"># Initialize the LLM chain and setup Retrieval QA</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">initialize_llm_chain</span><span class="p">(</span><span class="n">vectordb</span><span class="o">=</span><span class="n">vectordb</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qa</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dd8806f2.min.js"></script>
      
    
  </body>
</html>